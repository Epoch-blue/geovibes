# Evaluate Your Geospatial Models Vibes

Yeah benchmarks are cool and stuff, but how are your model's vibes? With this tooling you'll hopefully be able to see via the magic of search/retrieval. 

This repo is a heavily modified fork of the [original notebook tooling](https://github.com/earth-genome/ei-notebook) released by the [Earth Genome](https://www.earthgenome.org/). It also currently heavily leverages the embeddings generated and released for free by the Earth Genome and released on [Source Cooperative](https://source.coop/repositories/earthgenome/earthindexembeddings/access). 

We also use [Sentinel-2 composites](https://medium.com/earthrisemedia/earth-index-imagery-v2-40674f18b4d2) generated by, you guessed it, the Earth Genome. These are called '[Hutch](https://www.linkedin.com/in/tom-ingold/) Tile', in the tool because that was their original name in the notebook, and I find it hilarious, and also because people who do things deserve credit for said things.


## Prerequisites

### 1. Python Environment
Create and activate a conda environment:
```bash
mamba create -n geovibes python=3.12 -y
mamba activate geovibes
mamba install -c conda-forge --file ./requirements.txt -y
```

### 2. Earth Engine Authentication (Optional - for NDVI/NDWI basemaps)
Earth Engine authentication is **completely optional**. GeoVibes works perfectly without it! 

If you want to use NDVI and NDWI basemaps, you'll need to authenticate with Google Earth Engine:

```bash
# Install the Earth Engine API (if not already installed)
mamba install -c conda-forge earthengine-api -y

# Authenticate with Earth Engine
earthengine authenticate
```

Follow the authentication flow in your browser. This is only required if you want the NDVI/NDWI basemap options.


**âœ… GeoVibes works great without Earth Engine!** 

You'll still have access to:
- All core labeling functionality (point and polygon selection)
- Similarity search and embedding-based retrieval
- Multiple basemap options (MapTiler satellite, Hutch tiles (2024-2025), Google Hybrid)
- Dataset saving and loading
- All the key features you need!

Earth Engine only adds NDVI and NDWI basemaps, which are nice-to-have but not essential.

## Get Embeddings 

As of now only the softcon embeddings generated by the Earth Genome are available for use. In the future we will be adding functionality for users to generate their own embeddings. If you would like to contribute compute/storage/general good vibes to this, please contact us at chris@demeterlabs.io

To pull the embeddings for an aoi, assuming you have a file called `aoi.geojson` and want to save the land-filtered embeddings to a directory called `aoi_embeddings` use the `region_to_embeddings.py` script, from the root directory of `geovibes` run:

```
python src/region_to_embeddings.py aoi.geojson --filter-land-only --mgrs-reference-file /geometries/MGRS_LAND.geojson --out-dir /aoi_embeddings
```
This will download the MGRS tile embeddings which overlap to your aoi, and filter them to only keep those that fall within a buffered version of your aoi.

## Build DuckDB Embeddings Database

Once you have your embeddings downloaded locally, use the `duckdb_embedding_index.py` script to generate a queryable, similarity searchable table. Default distance metric is cosine similarity.

```
python -m duckdb_embedding_index /aoi_embddings aoi.db
```

will produce a duckdb database with an an HSNW index built for similarity searching, and an RTree index built for fast spatial searching. I've benchmarked this with up to 10M vectors, and it can take ~ 1.5 hours to build. I'm still not sure how this scales though, because 5M vectors take around 10-15 minutes to build (??).

Things to investigate: duckdb FAISS extension, using duckdb as just the store and an external HSNW (FAISS/Annoy etc...), running an in-memory db (Qdrant) etc... if you want to contribute compute/storage/goodvibes to this effort, again contact chris@demeterlabs.io, or just fork the repo and go for it.

## Generate a GeoVibes Config

Once this is complete, simply add the path to your embeddings db + the geojson used to generate the file to a config file, along with the start and end time for the imagery used to generate the embeddings, for example:

```json
{
    "duckdb_path": "/Users/christopherren/geovibes/data/java_land_cosine.db",
    "boundary_path": "/Users/christopherren/geovibes/geometries/java.geojson",
    "start_date": "2024-01-01",
    "end_date": "2025-01-01"
}
```

## Check Vibes
The `vibe_checker.ipynb` notebook provides an interactive map interface for labeling geographic points. Key features:

- Interactive map with multiple basemap options (Maptiler satellite, S2-RGB composite, Google Hybrid, S2-NDVI, S2-NDWI). **Please note that the NDVI/NDWI are generated on the fly from GEE. The dates for this imagery should be set using the config.**
- Point and lasso selection modes for efficient labeling
- Positive/negative/erase labeling options
- Direct Google Maps linking for reference
- Automatic saving of labeled points as GeoJSON files

### Label a point and search

### Polygon Labeling

### Save Dataset

### Load Dataset
















